
==========
 Graphite
==========

sudo apt install python2.7 python2.7-dev build-essential libcairo2-dev libffi-dev
sudo apt install python-pip
sudo pip install --upgrade pip

##/usr/local/lib/python2.7/dist-packages

export PYTHONPATH="/opt/graphite/lib/:/opt/graphite/webapp/"
sudo pip install --no-binary=:all: https://github.com/graphite-project/whisper/tarball/master
   Successfully installed whisper-1.1.0
sudo pip install --no-binary=:all: https://github.com/graphite-project/carbon/tarball/master
   Successfully installed Automat-0.6.0 Twisted-17.1.0 attrs-17.2.0 cachetools-2.0.0 carbon constantly-15.1.0 incremental-17.5.0 six-1.10.0 txAMQP-0.7.0 zope.interface-4.4.1
sudo pip install --no-binary=:all: https://github.com/graphite-project/graphite-web/tarball/master
   Successfully installed Django-1.9.13 cairocffi-0.8.0 cffi-1.10.0 django-tagging-0.4.3 graphite-web pycparser-2.17 pyparsing-2.2.0 pytz-2017.2 scandir-1.5 urllib3-1.21.1

sudo apt install apache2 apache2-dev

wget https://github.com/GrahamDumpleton/mod_wsgi/archive/4.5.15.tar.gz
tar xvfz 4.5.15.tar.gz
cd mod_wsgi-4.5.15
sudo ./configure
sudo make
sudo make install
   Libraries have been installed in:
      /usr/lib/apache2/modules
   chmod 644 /usr/lib/apache2/modules/mod_wsgi.so

sudo nano /opt/graphite/webapp/graphite/local_settings.py
   SECRET_KEY = '6Hgw0bBhds/HX$6$#4YXP`G2;yCfbGT&T^q~k5\V'
   TIME_ZONE = 'America/Denver'

sudo PYTHONPATH=/opt/graphite/webapp django-admin.py migrate --settings=graphite.settings --run-syncdb
sudo PYTHONPATH=/opt/graphite/webapp django-admin.py collectstatic --noinput --settings=graphite.settings

cd /opt/graphite/conf
sudo cp graphite.wsgi.example graphite.wsgi
sudo nano graphite.wsgi
   import os, sys
   sys.path.append('/opt/graphite/webapp')
   os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'graphite.settings')

   import django
   django.setup()
   from django.core.handlers.wsgi import WSGIHandler
   application = WSGIHandler()
   
cd /opt/graphite
sudo chown www-data storage
cd storage
sudo chown www-data:www-data graphite.db
cd log
sudo chown -R www-data:www-data webapp/

cd ~
sudo a2dissite 000-default
sudo nano /etc/apache2/sites-available/graphite-vhost.conf
   <VirtualHost *:80>
      ServerName graphite
      DocumentRoot "/opt/graphite/webapp"
      ErrorLog /opt/graphite/storage/log/webapp/error.log
      CustomLog /opt/graphite/storage/log/webapp/access.log common
      LoadModule wsgi_module /usr/lib/apache2/modules/mod_wsgi.so

      WSGIDaemonProcess graphite processes=5 threads=5 display-name='%{GROUP}' inactivity-timeout=120
      WSGIProcessGroup graphite
      WSGIApplicationGroup %{GLOBAL}
      WSGIImportScript /opt/graphite/conf/graphite.wsgi process-group=graphite application-group=%{GLOBAL}
      WSGIScriptAlias / /opt/graphite/conf/graphite.wsgi

      Alias /static/ /opt/graphite/static/
      Alias /media/ "/usr/local/lib/python2.7/dist-packages/django/contrib/admin/static/admin/"

      <Directory /opt/graphite/conf>
         Require all granted
      </Directory>

      <Directory /opt/graphite/static>
         Require all granted
      </Directory>

      <Directory /usr/local/lib/python2.7/dist-packages/django/contrib/admin/static/admin>
         Require all granted
      </Directory>

   </VirtualHost>

sudo a2ensite graphite-vhost
sudo service apache2 restart


cd /opt/graphite/conf
sudo nano carbon.conf
   [cache]
   DATABASE = whisper
   ENABLE_LOGROTATION = True
   USER =
   MAX_CACHE_SIZE = inf
   MAX_UPDATES_PER_SECOND = 500
   MAX_CREATES_PER_MINUTE = 50
   MIN_TIMESTAMP_RESOLUTION = 1
   LINE_RECEIVER_INTERFACE = 0.0.0.0
   LINE_RECEIVER_PORT = 2003
   CACHE_QUERY_INTERFACE = 0.0.0.0
   CACHE_QUERY_PORT = 7002
   USE_FLOW_CONTROL = True
   LOG_UPDATES = False
   LOG_CREATES = False
   LOG_CACHE_HITS = False
   LOG_CACHE_QUEUE_SORTS = False
   CACHE_WRITE_STRATEGY = sorted
   WHISPER_AUTOFLUSH = False
   WHISPER_FALLOCATE_CREATE = True

sudo nano storage-schemas.conf
   [carbon]
   pattern = ^carbon\.
   retentions = 60s:90d

   [collectd]
   pattern = ^collectd\.
   retentions = 10s:1w, 60s:1y

   [default]
   pattern = .*
   retentions = 60s:1y
   
sudo cp storage-aggregation.conf.example storage-aggregation.conf

sudo mkdir examples
sudo mv *.example examples
   
   
cd ~
sudo useradd -MUr carbon
sudo chgrp carbon /opt/graphite/storage
sudo chmod g+w /opt/graphite/storage
sudo chown carbon /opt/graphite/storage/whisper
sudo mkdir /opt/graphite/storage/log/carbon-cache
sudo chown -R carbon:carbon /opt/graphite/storage/log/carbon-cache
sudo nano /lib/systemd/system/carbon-cache.service
   [Unit]
   Description=carbon-cache
   After=network.target

   [Service]
   Type=forking
   User=carbon
   ExecStart=/opt/graphite/bin/carbon-cache.py start
   WorkingDirectory=/opt/graphite/bin
   Restart=on-failure

   [Install]
   WantedBy=multi-user.target

sudo systemctl daemon-reload
sudo systemctl start carbon-cache
   (service carbon-cache start|status|stop|restart)
sudo systemctl enable carbon-cache


cd ~
sudo apt install autoconf libtool
git clone https://github.com/statsite/statsite.git
cd statsite
./autogen.sh
./configure
make
sudo make install
cd /etc/statsite/
sudo cp statsite.conf.example statsite.conf
sudo nano statsite.conf
   [statsite]
   port=8125
   udp_port=8125
   log_level=INFO
   flush_interval=10
   timer_eps=0.01
   set_eps=0.02
   stream_cmd=python /usr/local/share/statsite/sinks/graphite.py localhost 2003
   daemonize=1
   pid_file=/etc/statsite/statsite.pid

   [histogram_api]
   prefix=api
   min=0
   max=100
   width=5

   [histogram_default]
   prefix=
   min=0
   max=200
   width=20

cd ~
sudo useradd -MUr statsite
sudo chown statsite /etc/statsite
sudo nano /lib/systemd/system/statsite.service
   [Unit]
   Description=statsite
   After=network.target

   [Service]
   Type=forking
   User=statsite
   ExecStart=/usr/local/bin/statsite -f /etc/statsite/statsite.conf
   Restart=on-failure

   [Install]
   WantedBy=multi-user.target

sudo systemctl daemon-reload
sudo systemctl start statsite
   (service statsite start|status|stop|restart)
sudo systemctl enable statsite


sudo apt install collectd
sudo mv /etc/collectd/collectd.conf /etc/collectd/collectd.conf.bak
sudo nano /etc/collectd/collectd.conf
Hostname "graphite"
AutoLoadPlugin false

LoadPlugin syslog
LoadPlugin cpu
LoadPlugin df
LoadPlugin disk
LoadPlugin interface
LoadPlugin memory
LoadPlugin swap
LoadPlugin write_graphite

<Plugin syslog>
   LogLevel info
</Plugin>
<Plugin cpu>
   ReportByCpu true
   ReportByState true
   ValuesPercentage false
</Plugin>
<Plugin "df">
  FSType "ext4"
</Plugin>
<Plugin disk>
   Disk "sda"
   IgnoreSelected false
</Plugin>
<Plugin interface>
   Interface "eth0"
   IgnoreSelected false
</Plugin>
<Plugin write_graphite>
   <Node "graphite">
      Host "localhost"
      Protocol "tcp"
      LogSendErrors true
      Prefix "collectd."
   </Node>
</Plugin>

<Include "/etc/collectd/collectd.conf.d">
   Filter "*.conf"
</Include>

sudo service collectd restart


wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana_4.2.0_amd64.deb 
sudo dpkg -i grafana_4.2.0_amd64.deb 
sudo /bin/systemctl daemon-reload
sudo /bin/systemctl enable grafana-server
sudo /bin/systemctl start grafana-server


sudo netstat -lpnt
   Active Internet connections (only servers)
   Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
   tcp        0      0 0.0.0.0:2003            0.0.0.0:*               LISTEN      19153/python
   tcp        0      0 0.0.0.0:2004            0.0.0.0:*               LISTEN      19153/python
   tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1087/sshd
   tcp        0      0 0.0.0.0:7002            0.0.0.0:*               LISTEN      19153/python
   tcp6       0      0 :::80                   :::*                    LISTEN      18760/apache2
   tcp6       0      0 :::22                   :::*                    LISTEN      1087/sshd
   tcp6       0      0 :::3000                 :::*                    LISTEN      26956/grafana-serve
   tcp6       0      0 :::8125                 :::*                    LISTEN      31389/statsite


http://10.1.2.97:3000
Add data source
   Name: graphite
   Type: Graphite
   Url: http://localhost
   Access: proxy




